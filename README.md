## é¡¹ç›®ä»‹ç»

ä½¿ç”¨ Go è¯­è¨€åŸºäº Redis serialization protocol (RESP) å®ç°ç®€æ˜“çš„ Redisï¼Œä¸»è¦å·¥ä½œï¼šTCP æœåŠ¡å™¨ã€åè®®è§£æå™¨ã€å†…å­˜æ•°æ®åº“ã€æŒä¹…åŒ–ã€é›†ç¾¤

**ç¼–è¯‘è¿è¡Œï¼š**

```shell
# å•æœºç‰ˆ
go build main.go && ./main
# å®¢æˆ·ç«¯ telnet æˆ– redis-cli
telnet 127.0.0.1 6379
redis-cli -h 127.0.0.1
# é›†ç¾¤ç‰ˆ
```

## å®ç°é€»è¾‘

**TCP æœåŠ¡å™¨çš„å¯åŠ¨ï¼š**

main â†’ ListenAndServeWithSignal â†’ ListenAndServer ğŸ” â†’ HandleğŸ”

**åè®®è§£æå™¨çš„å·¥ä½œï¼š**

![](https://cdn.jsdelivr.net/gh/hcjjj/blog-img/RESP.svg)

Redis ç½‘ç»œåè®®ï¼Œ**[Redis serialization protocol specification](https://redis.io/docs/reference/protocol-spec/)**
* æ­£å¸¸å›å¤ï¼ˆRedis â†’ Clientï¼‰
  * ä»¥ "+" å¼€å¤´ï¼Œä»¥ "\r\n" ç»“å°¾çš„å­—ç¬¦ä¸²å½¢å¼
  * å¦‚ï¼š`+OK\r\n`
* é”™è¯¯å›å¤ï¼ˆRedis â†’ Clientï¼‰
  * ä»¥ "-" å¼€å¤´ï¼Œä»¥ "\r\n" ç»“å°¾çš„å­—ç¬¦ä¸²å½¢å¼
  * å¦‚ï¼š`-Error message\r\n`
* æ•´æ•°ï¼ˆRedis â‡„ Clientï¼‰
  * ä»¥ ":" å¼€å¤´ï¼Œä»¥ "\r\n" ç»“å°¾çš„å­—ç¬¦ä¸²å½¢å¼
  * å¦‚ï¼š`:123456\r\n`
* å•è¡Œå­—ç¬¦ä¸²ï¼ˆRedis â‡„ Clientï¼‰
  * ä»¥ "$" å¼€å¤´ï¼Œåè·Ÿå®é™…å‘é€å­—èŠ‚æ•°ï¼Œä»¥ "\r\n" ç»“å°¾
  * "Redis"ï¼š`$5\r\nRedis\r\n`
  * ""ï¼š`$0\r\n\r\n`
  * "Redis\r\ngo"ï¼š`$11\r\nRedis\r\ngo\r\n`
* å¤šè¡Œå­—ç¬¦ä¸²ï¼ˆæ•°ç»„ï¼‰ï¼ˆRedis â‡„ Clientï¼‰
  * ä»¥ "*" å¼€å¤´ï¼Œåè·Ÿæˆå‘˜ä¸ªæ•°
  * æœ‰3ä¸ªæˆå‘˜çš„æ•°ç»„[SET, key, value]ï¼š`*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$5\r\nvalue\r\n`

### å†…å­˜æ•°æ®åº“

KV å†…å­˜æ•°æ®åº“çš„æ ¸å¿ƒæ˜¯å¹¶å‘å®‰å…¨çš„å“ˆå¸Œè¡¨ **sync.map**

### æŒä¹…åŒ–

AOF æŒä¹…åŒ–æ˜¯å…¸å‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œä¸»åç¨‹ (goroutine) å¯ä»¥ä½¿ç”¨ channel å°†æ•°æ®å‘é€åˆ°å¼‚æ­¥åç¨‹ç”±å¼‚æ­¥åç¨‹æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œ

### é›†ç¾¤

å•å°æœåŠ¡å™¨çš„CPUå’Œå†…å­˜ç­‰èµ„æºæ˜¯æœ‰é™çš„ï¼Œåˆ©ç”¨å¤šå°æœºå™¨å»ºç«‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ†å·¥å¤„ç†æ¥æé«˜ç³»ç»Ÿå®¹é‡å’Œååé‡

## ç›®å½•ç»“æ„

```shell
â”œâ”€â”€ aof # AOF æŒä¹…åŒ–
â”œâ”€â”€ cluster # é›†ç¾¤
â”œâ”€â”€ config # è§£æé…ç½®æ–‡ä»¶ redis.conf
â”œâ”€â”€ database # å†…å­˜æ•°æ®åº“
â”œâ”€â”€ datastruct # æ”¯æŒçš„æ•°æ®ç»“æ„
â”‚Â Â  â””â”€â”€ dict
â”œâ”€â”€ interface # æ¥å£å®šä¹‰
â”‚Â Â  â”œâ”€â”€ database
â”‚Â Â  â”œâ”€â”€ resp
â”‚Â Â  â””â”€â”€ tcp
â”œâ”€â”€ lib # åŸºç¡€å·¥å…·
â”‚Â Â  â”œâ”€â”€ consistenthash # ä¸€è‡´æ€§å“ˆå¸Œ
â”‚Â Â  â”œâ”€â”€ logger # æ—¥å¿—è®°å½•
â”‚Â Â  â”œâ”€â”€ sync # åŒæ­¥å·¥å…·
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ atomic
â”‚Â Â  â”‚Â Â  â””â”€â”€ wait
â”‚Â Â  â”œâ”€â”€ utils # æ ¼å¼è½¬æ¢
â”‚Â Â  â””â”€â”€ wildcard # é€šé…ç¬¦
â”œâ”€â”€ resp # RESP è§£æ
â”‚Â Â  â”œâ”€â”€ client
â”‚Â Â  â”œâ”€â”€ connection
â”‚Â Â  â”œâ”€â”€ handler
â”‚Â Â  â”œâ”€â”€ parser # è§£æå®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®
â”‚Â Â  â””â”€â”€ reply # å°è£…æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„å›å¤
â””â”€â”€ tcp # TCP æœåŠ¡å™¨
```

## æµ‹è¯•å‘½ä»¤

* set key value `*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$5\r\nvalue\r\n`
* select 2 `*2\r\n$6\r\nselect\r\n$1\r\n1\r\n`
* get key `*2\r\n$3\r\nGET\r\n$3\r\nkey\r\n`
